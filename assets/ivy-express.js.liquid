document.addEventListener("DOMContentLoaded", () => {
  const expressButtons = document.querySelectorAll(
    "button.ivy-express-checkout"
  );

  expressButtons.forEach((button) => {
    button.addEventListener("click", async () => {
      if (
        button.dataset.type === "product" &&
        button.dataset.product &&
        button.dataset.shopifyVariant
      ) {
        await fetch(`${window.Shopify.routes.root}cart/add.js`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            items: [
              {
                id: button.dataset.shopifyVariant,
                quantity: 1,
              },
            ],
          }),
        });
      }

      fetch("/cart?view=ivy")
        .then((response) => response.json())
        .then((cartData) => {
          fetch('{{ settings.ivy_gateway_url }}/checkout/express/create', {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(cartData),
          })
            .then((response) => response.json())
            .then((checkoutSessionData) => {
              startIvyCheckout(checkoutSessionData.redirectUrl, "popup");
            })
            .catch((error) => console.error("Error:", error));
        });
    });
  });
});
